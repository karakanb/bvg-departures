<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>BVG Departures</title>
  <meta name="description" content="Lists the departure times of bus, tram and U-Bahn lines for BVG stations.">
  <meta name="author" content="Burak Karakan">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">

  <link rel="icon" type="image/png" href="images/favicon.png">
  <style>
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      justify-content: space-between;
    }

    .container {
      padding-bottom: 24px;
    }

    footer {
      font-size: smaller;
    }

    table {
      border-collapse: collapse;
    }

    td,
    th {
      padding: 12px 6px;
    }

    code {
      margin: 0;
      white-space: inherit;
      overflow-wrap: break-word;
    }

    .station-name {
      margin-bottom: 4px;
    }

    .last-updated,
    footer {
      color: #616161;
    }

    /* Larger than tablet */
    @media (min-width: 750px) {
      .station-name {
        display: inline-block;
      }

      .last-updated {
        margin-left: 8px;
      }

    }

    .tram-body:not(:last-child) {
      border-bottom: 4px solid #E1E1E1;
      margin-bottom: 2rem;
    }

    .table-wrapper {
      overflow: scroll;
    }

    .tram-body table>tbody tr:nth-child(odd) {
      background-color: #f9f9f9;
    }

    .catchable {
      text-align: center;
    }

    .tram-body table>thead>tr>th:first-child,
    .tram-body table>tbody>tr>td:first-child {
      padding-left: 8px !important;
    }

    .tram-body table>thead>tr>th:last-child,
    .tram-body table>tbody>tr>td:last-child {
      padding-right: 8px !important;
    }

    .circle {
      width: 12px;
      height: 12px;
      border-radius: 12px;
      display: inline-block;
    }

    .danger {
      color: #ce0909;
    }

    .warning {
      color: #E6A23C;
    }

    .success {
      color: #2c8401;
    }

    .align-right {
      text-align: right;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="column" style="margin-top: 5%">
        <h1 id="main-title">BVG Departures</h1>
        <div id="trams">
          <div id="app">
            <div v-if="!this.stationsEmpty" id="trams">
              <div v-for="station in stations" class="tram-body">
                <div class="row">
                  <h4 class="station-name">
                    <code>{{station.name}}</code>
                  </h4>
                  <span class="last-updated">
                    {{ lastUpdated[station.id] ? `Last updated: ${lastUpdated[station.id].toLocaleString()}` : "Fetching data..."}}
                  </span>
                </div>
                <div class="table-wrapper row u-full-width">
                  <table class="u-full-width">
                    <thead>
                      <tr>
                        <th>Line</th>
                        <th>Direction</th>
                        <th class="align-right">When</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="departure in departures[station.id]" class="line-row">
                        <td class="name">{{departure.line.name}}</td>
                        <td class="direction">{{departure.direction}}</td>
                        <td class="when align-right" :class="getCatchableStatus(departure.when)">
                          {{ timeUntil( new Date(departure.when))}}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div v-else>
              LINES EMPTY
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer>
      BVG Departures is an <a href="https://github.com/karakanb/bvg-departures" target="_blank">open-source project</a>,
      feel free to create issues, report bugs and contribute.
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script>
    const apiBaseUrl = 'https://bvg-rest-api.now.sh';
    const catchableDefinitions = {
      danger: 'It is not likely for you to be able to catch this.',
      warning: 'You can catch this one if you leave immediately.',
      success: 'You can catch this one easily, no worries.',
    };
  </script>
  <script>
    var app = new Vue({
      el: '#app',
      data: {
        stations: localStorage.getItem('stations') || [],
        lastUpdated: {},
        departures: {},
        duration: 5,
      },
      created() {
        console.log("created")
        this.stations = [
          {
            id: '900000110022',
            name: 'Mollstr./Prenzlauer Allee',
          },
          {
            id: '900000110005',
            name: 'U Senefelderplatz',
          }
        ];

        for (const station of this.stations) {
          this.fetchDepartures(station.id, station.name, this.duration);
          setInterval(() => this.fetchDepartures(station.id, station.name, this.duration), 5 * 1000);
        }
        console.log("initiated fetch")
      },
      methods: {
        // fetchRetry runs a fetch operation with a recursive retry call with given N times.
        fetchRetry(url, n) {
          return fetch(url)
            .then(response => {
              if (response.status !== 200) {
                throw new Error("not successful response");
              }

              return response;
            })
            .catch(error => {
              if (n === 1) throw error;
              return this.fetchRetry(url, n - 1);
            });
        },

        fetchDepartures(stationId, stationName, duration) {
          const tramDepartureUrl = `${apiBaseUrl}/stations/${stationId}/departures?duration=${duration}`;
          this.fetchRetry(tramDepartureUrl, 3)
            .then(response => {
              response.json().then(data => {
                Vue.set(this.departures, stationId, data);
                Vue.set(this.lastUpdated, stationId, new Date());
              })
            });
        },

        getCatchableStatus(when) {
          const diffInMinutes = this.timeDiffMinutes(new Date(when), new Date());
          if (diffInMinutes < 3) {
            return 'danger';
          } else if (diffInMinutes < 6) {
            return 'warning';
          }

          return 'success';
        },

        timeDiffMinutes(dt2, dt1) {
          var diff = (dt2.getTime() - dt1.getTime()) / 1000;
          return Math.abs(Math.round(diff / 60));
        },

        timeUntil(timeStamp) {
          return this.timeDistance(timeStamp, new Date());
        },

        timeSince(timeStamp) {
          return this.timeDistance(new Date(), timeStamp, new Date());
        },

        timeDistance(t1, t2) {
          const secondsPast = (t1.getTime() - t2.getTime()) / 1000;
          if (secondsPast <= 60) {
            return '< 1m';
          }
          if (secondsPast < 3600) {
            return parseInt(secondsPast / 60) + 'm';
          }
          if (secondsPast <= 86400) {
            return parseInt(secondsPast / 3600) + 'h';
          }
          if (secondsPast > 86400) {
            day = timeStamp.getDate();
            month = timeStamp.toDateString().match(/ [a-zA-Z]*/)[0].replace(" ", "");
            year = timeStamp.getFullYear() == now.getFullYear() ? "" : " " + timeStamp.getFullYear();
            return day + " " + month + year;
          }
        },
      },
      computed: {
        stationsEmpty() {
          return this.stations === undefined || this.stations.length === 0;
        }
      },
    });
  </script>

</body>

</html>